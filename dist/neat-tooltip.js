/// <reference path="typings/tsd.d.ts" />
var Tooltip;
(function (_Tooltip) {
    _Tooltip.activeTooltips = [];
    function close() {
        for (var i = 0; i < _Tooltip.activeTooltips.length; i++)
            _Tooltip.activeTooltips[i].close();
    }
    //Indicates if a jquery set contains a given DOM node
    function $contains(e, elem, includeSelf) {
        if (includeSelf === void 0) { includeSelf = true; }
        for (var i = 0; i < e.length; i++) {
            if ((includeSelf && e.get(i) == elem) || $.contains(e.get(i), elem))
                return true;
        }
        return false;
    }
    ;
    (function ($) {
        //Display a tooltip once
        $.fn.showTooltip = function (options) {
            return this.each(function () {
                new Tooltip(this, options);
            });
        };
        //Display a tooltip once
        $.fn.closeTooltip = function (options) {
            return this.each(function () {
                var t = $(this).data('_tooltip');
                if (t)
                    t.close();
            });
        };
        //Bind tooltip display to event
        $.fn.tooltip = function (options, showOn, selector) {
            if (showOn === void 0) { showOn = 'hover'; }
            if (showOn == 'hover') {
                var show = function () {
                    $(this).showTooltip(options);
                };
                this.on('mouseenter', selector, show).on('mouseleave', selector, function () {
                    $(this).closeTooltip();
                }).on('click', selector, show);
            }
            else if (showOn == 'click') {
                this.on('click', selector, function () {
                    var e = $(this);
                    if (e.data('_tooltip'))
                        e.closeTooltip();
                    else
                        e.showTooltip(options);
                    return false;
                });
            }
            else {
                throw 'This value is not supported for argument showOn: ' + showOn;
            }
            return this;
        };
        //Hide tooltip on click outside target element and popup
        $('html').click(function (ev) {
            for (var i = 0; i < _Tooltip.activeTooltips.length; i++) {
                var t = _Tooltip.activeTooltips[i];
                var $active = t.tooltip.add(t.target);
                if (t && t.options.closeOnClickOuside && !$contains($active, ev.target))
                    t.close();
            }
        });
        $(window).resize(function () {
            for (var i = 0; i < _Tooltip.activeTooltips.length; i++) {
                _Tooltip.activeTooltips[i].position();
            }
        });
    })(jQuery);
    var Tooltip = (function () {
        function Tooltip(targetElem, options) {
            var _this = this;
            this.targetElem = targetElem;
            this.options = options;
            this.closeCallback = function () {
                _this.close();
                return false;
            };
            this.options = $.extend({
                position: 'bottom',
                source: 'title',
                cssClass: '',
                closeSelector: '.tooltip-close',
                distance: 5,
                allowMultiple: false,
                closeOnClickOuside: true,
                delay: 200,
                container: window,
                margin: 10
            }, options);
            this.target = $(targetElem).addClass('has-tooltip').closeTooltip().data('_tooltip', this);
            this.showTimeout = setTimeout(function () { return _this.show(); }, this.options.delay);
        }
        Tooltip.prototype.getContent = function () {
            var c = this.options.content;
            if (c) {
                c = $.isFunction(c) ? c.call(this.target) : c;
                return !c ? null : typeof c == 'string' ? $('<div>').html(c) : $(c);
            }
            if (this.options.source == 'title') {
                var title = this.target.attr('title') || this.target.data('title');
                this.target.attr('title', '').data('title', title);
                return $('<div>').html(title);
            }
            if (this.options.source == 'anchor') {
                var content = $(this.target.attr('href'));
                return content.length ? content : null;
            }
        };
        Tooltip.prototype.show = function () {
            this.content = this.getContent();
            if (!this.content)
                return;
            if (!this.options.allowMultiple)
                close();
            this.content.off('click', this.closeCallback).on('click', this.options.closeSelector, this.closeCallback);
            var o = this.options;
            this.tooltip = $('<div class="tooltip-frame"/>').addClass(o.cssClass).addClass('tooltip-' + o.position).append(this.content.show()).append($('<div class="tip"/>')).appendTo('body');
            _Tooltip.activeTooltips.push(this);
            this.position();
        };
        Tooltip.prototype.position = function () {
            var margin = this.options.margin;
            var t = this.tooltip;
            var e = this.target;
            var o = this.options;
            if (!t)
                return;
            //Reset so dimentions calculations are correct
            t.removeAttr('style');
            var offset = e.offset();
            var container = this.options.container;
            var containerLeft = container === window ? 0 : $(container).offset().left;
            var minLeft = containerLeft + margin;
            var maxRight = (containerLeft + $(container).outerWidth()) - margin;
            var w = t.outerWidth();
            var left = Math.max(minLeft, offset.left + e.outerWidth() / 2 - w / 2);
            var rightOverflow = (left + w) - maxRight;
            if (rightOverflow > 0)
                left = Math.max(minLeft, left - rightOverflow);
            t.css({
                'left': left + 'px',
                'max-width': (maxRight - left) + 'px'
            }).find('.tip').css('left', offset.left + e.outerWidth() / 2 - left + 'px');
            //Setting width can make height vary. So we set vertical position after.
            var h = t.outerHeight();
            t.css('top', o.position == 'top' ? offset.top - h - o.distance : offset.top + e.outerHeight() + o.distance);
        };
        Tooltip.prototype.close = function () {
            clearTimeout(this.showTimeout);
            if (!this.tooltip)
                return;
            if (this.options.source == 'anchor')
                this.content.hide().appendTo('body');
            this.tooltip.remove();
            this.tooltip = null;
            this.target.data('_tooltip', null);
            _Tooltip.activeTooltips.splice(_Tooltip.activeTooltips.indexOf(this), 1);
        };
        return Tooltip;
    })();
    _Tooltip.Tooltip = Tooltip;
})(Tooltip || (Tooltip = {}));

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5lYXQtdG9vbHRpcC50cyJdLCJuYW1lcyI6WyJUb29sdGlwIiwiVG9vbHRpcC5jbG9zZSIsIlRvb2x0aXAuJGNvbnRhaW5zIiwiVG9vbHRpcC5Ub29sdGlwIiwiVG9vbHRpcC5Ub29sdGlwLmNvbnN0cnVjdG9yIiwiVG9vbHRpcC5Ub29sdGlwLmdldENvbnRlbnQiLCJUb29sdGlwLlRvb2x0aXAuc2hvdyIsIlRvb2x0aXAuVG9vbHRpcC5wb3NpdGlvbiIsIlRvb2x0aXAuVG9vbHRpcC5jbG9zZSJdLCJtYXBwaW5ncyI6IkFBQUEseUNBQXlDO0FBSXpDLElBQU8sT0FBTyxDQWtNYjtBQWxNRCxXQUFPLFFBQU8sRUFBQyxDQUFDO0lBQ0RBLHVCQUFjQSxHQUFjQSxFQUFFQSxDQUFDQTtJQUUxQ0EsU0FBU0EsS0FBS0E7UUFDVkMsR0FBR0EsQ0FBQUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBQ0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBQ0EsdUJBQWNBLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBLEVBQUVBO1lBQ3JDQSx1QkFBY0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsS0FBS0EsRUFBRUEsQ0FBQ0E7SUFDbENBLENBQUNBO0lBRURELEFBQ0FBLHFEQURxREE7YUFDNUNBLFNBQVNBLENBQUNBLENBQVNBLEVBQUVBLElBQWlCQSxFQUFFQSxXQUFrQkE7UUFBbEJFLDJCQUFrQkEsR0FBbEJBLGtCQUFrQkE7UUFDL0RBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBLEVBQUVBLEVBQUVBLENBQUNBO1lBQ2hDQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxXQUFXQSxJQUFJQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxJQUFJQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQTtnQkFDaEVBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBO1FBQ3BCQSxDQUFDQTtRQUNEQSxNQUFNQSxDQUFDQSxLQUFLQSxDQUFDQTtJQUNqQkEsQ0FBQ0E7SUFBQUYsQ0FBQ0E7SUFFRkEsQ0FBQ0EsVUFBVUEsQ0FBQ0E7UUFFUixBQUNBLHdCQUR3QjtRQUN4QixDQUFDLENBQUMsRUFBRSxDQUFDLFdBQVcsR0FBRyxVQUFVLE9BQU87WUFDaEMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7Z0JBQ2IsSUFBSSxPQUFPLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQy9CLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDO1FBRUYsQUFDQSx3QkFEd0I7UUFDeEIsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxZQUFZLEdBQUcsVUFBVSxPQUFPO1lBQ2pDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO2dCQUNiLElBQUksQ0FBQyxHQUFZLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7Z0JBQzFDLEVBQUUsQ0FBQSxDQUFDLENBQUMsQ0FBQztvQkFDRCxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDbEIsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUM7UUFFRixBQUNBLCtCQUQrQjtRQUMvQixDQUFDLENBQUMsRUFBRSxDQUFDLE9BQU8sR0FBRyxVQUFVLE9BQU8sRUFBRSxNQUFnQixFQUFFLFFBQWdCO1lBQWxDLHNCQUFnQixHQUFoQixnQkFBZ0I7WUFDOUMsRUFBRSxDQUFDLENBQUMsTUFBTSxJQUFJLE9BQU8sQ0FBQyxDQUFDLENBQUM7Z0JBQ3BCLElBQUksSUFBSSxHQUFHO29CQUFjLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUE7Z0JBQUMsQ0FBQyxDQUFDO2dCQUN4RCxJQUFJLENBQ0MsRUFBRSxDQUFDLFlBQVksRUFBRSxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQ2hDLEVBQUUsQ0FBQyxZQUFZLEVBQUUsUUFBUSxFQUFFO29CQUFXLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxZQUFZLEVBQUUsQ0FBQTtnQkFBQSxDQUFDLENBQUMsQ0FDOUQsRUFBRSxDQUFDLE9BQU8sRUFBRSxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFFckMsQ0FBQztZQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxNQUFNLElBQUksT0FBTyxDQUFDLENBQUEsQ0FBQztnQkFDMUIsSUFBSSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsUUFBUSxFQUFFO29CQUN2QixJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7b0JBQ2hCLEVBQUUsQ0FBQSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7d0JBQ2xCLENBQUMsQ0FBQyxZQUFZLEVBQUUsQ0FBQztvQkFDckIsSUFBSTt3QkFDQSxDQUFDLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO29CQUMzQixNQUFNLENBQUMsS0FBSyxDQUFDO2dCQUNqQixDQUFDLENBQUMsQ0FBQztZQUNQLENBQUM7WUFBQSxJQUFJLENBQUEsQ0FBQztnQkFDRixNQUFNLG1EQUFtRCxHQUFHLE1BQU0sQ0FBQztZQUN2RSxDQUFDO1lBRUQsTUFBTSxDQUFDLElBQUksQ0FBQztRQUNoQixDQUFDLENBQUM7UUFFRixBQUNBLHdEQUR3RDtRQUN4RCxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQVUsRUFBRTtZQUN4QixHQUFHLENBQUEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFDLENBQUMsRUFBRSxDQUFDLEdBQUMsdUJBQWMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUMsQ0FBQztnQkFDdkMsSUFBSSxDQUFDLEdBQVcsdUJBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDbEMsSUFBSSxPQUFPLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUN0QyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDO29CQUNwRSxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDbEIsQ0FBQztRQUVMLENBQUMsQ0FBQyxDQUFDO1FBRUgsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQztZQUNiLEdBQUcsQ0FBQSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUMsQ0FBQyxFQUFFLENBQUMsR0FBQyx1QkFBYyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBQyxDQUFDO2dCQUN2Qyx1QkFBYyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ2pDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQ0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0E7SUFFWEEsSUFBYUEsT0FBT0E7UUFPaEJHLFNBUFNBLE9BQU9BLENBT0lBLFVBQXVCQSxFQUFTQSxPQUF3QkE7WUFQaEZDLGlCQW1IQ0E7WUE1R3VCQSxlQUFVQSxHQUFWQSxVQUFVQSxDQUFhQTtZQUFTQSxZQUFPQSxHQUFQQSxPQUFPQSxDQUFpQkE7WUFIcEVBLGtCQUFhQSxHQUFHQTtnQkFBUUEsS0FBSUEsQ0FBQ0EsS0FBS0EsRUFBRUEsQ0FBQ0E7Z0JBQUNBLE1BQU1BLENBQUNBLEtBQUtBLENBQUNBO1lBQUNBLENBQUNBLENBQUNBO1lBSTFEQSxJQUFJQSxDQUFDQSxPQUFPQSxHQUFHQSxDQUFDQSxDQUFDQSxNQUFNQSxDQUFDQTtnQkFDcEJBLFFBQVFBLEVBQUVBLFFBQVFBO2dCQUNsQkEsTUFBTUEsRUFBRUEsT0FBT0E7Z0JBQ2ZBLFFBQVFBLEVBQUVBLEVBQUVBO2dCQUNaQSxhQUFhQSxFQUFFQSxnQkFBZ0JBO2dCQUMvQkEsUUFBUUEsRUFBRUEsQ0FBQ0E7Z0JBQ1hBLGFBQWFBLEVBQUVBLEtBQUtBO2dCQUNwQkEsa0JBQWtCQSxFQUFFQSxJQUFJQTtnQkFDeEJBLEtBQUtBLEVBQUVBLEdBQUdBO2dCQUNWQSxTQUFTQSxFQUFFQSxNQUFNQTtnQkFDakJBLE1BQU1BLEVBQUVBLEVBQUVBO2FBQ2JBLEVBQUVBLE9BQU9BLENBQUNBLENBQUNBO1lBRVpBLElBQUlBLENBQUNBLE1BQU1BLEdBQUdBLENBQUNBLENBQUNBLFVBQVVBLENBQUNBLENBQUNBLFFBQVFBLENBQUNBLGFBQWFBLENBQUNBLENBQUNBLFlBQVlBLEVBQUVBLENBQUNBLElBQUlBLENBQUNBLFVBQVVBLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO1lBQzFGQSxJQUFJQSxDQUFDQSxXQUFXQSxHQUFHQSxVQUFVQSxDQUFDQSxjQUFNQSxPQUFBQSxLQUFJQSxDQUFDQSxJQUFJQSxFQUFFQSxFQUFYQSxDQUFXQSxFQUFFQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQTtRQUN6RUEsQ0FBQ0E7UUFFT0QsNEJBQVVBLEdBQWxCQTtZQUNJRSxJQUFJQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxPQUFPQSxDQUFDQTtZQUM3QkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ0pBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLFVBQVVBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLEdBQUdBLENBQUNBLENBQUNBO2dCQUM5Q0EsTUFBTUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsSUFBSUEsR0FBR0EsT0FBT0EsQ0FBQ0EsSUFBSUEsUUFBUUEsR0FBSUEsQ0FBQ0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDekVBLENBQUNBO1lBR0RBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLE1BQU1BLElBQUlBLE9BQU9BLENBQUNBLENBQUNBLENBQUNBO2dCQUNqQ0EsSUFBSUEsS0FBS0EsR0FBR0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsSUFBSUEsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ25FQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxFQUFFQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxFQUFFQSxLQUFLQSxDQUFDQSxDQUFDQTtnQkFDbkRBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBO1lBQ2xDQSxDQUFDQTtZQUNEQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxNQUFNQSxJQUFJQSxRQUFRQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDbENBLElBQUlBLE9BQU9BLEdBQUdBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBO2dCQUMxQ0EsTUFBTUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsTUFBTUEsR0FBR0EsT0FBT0EsR0FBR0EsSUFBSUEsQ0FBQ0E7WUFDM0NBLENBQUNBO1FBQ0xBLENBQUNBO1FBRU9GLHNCQUFJQSxHQUFaQTtZQUNJRyxJQUFJQSxDQUFDQSxPQUFPQSxHQUFHQSxJQUFJQSxDQUFDQSxVQUFVQSxFQUFFQSxDQUFDQTtZQUNqQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0E7Z0JBQ2RBLE1BQU1BLENBQUNBO1lBRVhBLEVBQUVBLENBQUFBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLGFBQWFBLENBQUNBO2dCQUMzQkEsS0FBS0EsRUFBRUEsQ0FBQ0E7WUFFWkEsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FDUEEsR0FBR0EsQ0FBQ0EsT0FBT0EsRUFBRUEsSUFBSUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsQ0FDaENBLEVBQUVBLENBQUNBLE9BQU9BLEVBQUVBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLGFBQWFBLEVBQUVBLElBQUlBLENBQUNBLGFBQWFBLENBQUNBLENBQUNBO1lBRWpFQSxJQUFJQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQTtZQUVyQkEsSUFBSUEsQ0FBQ0EsT0FBT0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsOEJBQThCQSxDQUFDQSxDQUMzQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FDcEJBLFFBQVFBLENBQUNBLFVBQVVBLEdBQUdBLENBQUNBLENBQUNBLFFBQVFBLENBQUNBLENBQ2pDQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxJQUFJQSxFQUFFQSxDQUFDQSxDQUMzQkEsTUFBTUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0Esb0JBQW9CQSxDQUFDQSxDQUFDQSxDQUMvQkEsUUFBUUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0E7WUFFdEJBLHVCQUFjQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUMxQkEsSUFBSUEsQ0FBQ0EsUUFBUUEsRUFBRUEsQ0FBQ0E7UUFDcEJBLENBQUNBO1FBRU1ILDBCQUFRQSxHQUFmQTtZQUNJSSxJQUFJQSxNQUFNQSxHQUFHQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxNQUFNQSxDQUFDQTtZQUVqQ0EsSUFBSUEsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0E7WUFDckJBLElBQUlBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBO1lBQ3BCQSxJQUFJQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQTtZQUVyQkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ0hBLE1BQU1BLENBQUNBO1lBRVhBLEFBQ0FBLDhDQUQ4Q0E7WUFDOUNBLENBQUNBLENBQUNBLFVBQVVBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBO1lBQ3RCQSxJQUFJQSxNQUFNQSxHQUFHQSxDQUFDQSxDQUFDQSxNQUFNQSxFQUFFQSxDQUFDQTtZQUN4QkEsSUFBSUEsU0FBU0EsR0FBR0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsU0FBU0EsQ0FBQ0E7WUFDdkNBLElBQUlBLGFBQWFBLEdBQUdBLFNBQVNBLEtBQUtBLE1BQU1BLEdBQUdBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLFNBQVNBLENBQUNBLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBLElBQUlBLENBQUFBO1lBQ3pFQSxJQUFJQSxPQUFPQSxHQUFHQSxhQUFhQSxHQUFHQSxNQUFNQSxDQUFDQTtZQUNyQ0EsSUFBSUEsUUFBUUEsR0FBR0EsQ0FBQ0EsYUFBYUEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsQ0FBQ0EsVUFBVUEsRUFBRUEsQ0FBQ0EsR0FBR0EsTUFBTUEsQ0FBQ0E7WUFFcEVBLElBQUlBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLFVBQVVBLEVBQUVBLENBQUNBO1lBRXZCQSxJQUFJQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQSxHQUFHQSxDQUFDQSxPQUFPQSxFQUFFQSxNQUFNQSxDQUFDQSxJQUFJQSxHQUFHQSxDQUFDQSxDQUFDQSxVQUFVQSxFQUFFQSxHQUFHQSxDQUFDQSxHQUFHQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUV2RUEsSUFBSUEsYUFBYUEsR0FBR0EsQ0FBQ0EsSUFBSUEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsUUFBUUEsQ0FBQ0E7WUFDMUNBLEVBQUVBLENBQUFBLENBQUNBLGFBQWFBLEdBQUdBLENBQUNBLENBQUNBO2dCQUNqQkEsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsT0FBT0EsRUFBRUEsSUFBSUEsR0FBR0EsYUFBYUEsQ0FBQ0EsQ0FBQUE7WUFFbERBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBO2dCQUNGQSxNQUFNQSxFQUFFQSxJQUFJQSxHQUFHQSxJQUFJQTtnQkFDbkJBLFdBQVdBLEVBQUVBLENBQUNBLFFBQVFBLEdBQUdBLElBQUlBLENBQUNBLEdBQUdBLElBQUlBO2FBQ3hDQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxNQUFNQSxFQUFFQSxNQUFNQSxDQUFDQSxJQUFJQSxHQUFHQSxDQUFDQSxDQUFDQSxVQUFVQSxFQUFFQSxHQUFHQSxDQUFDQSxHQUFHQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUM1RUEsQUFDQUEsd0VBRHdFQTtnQkFDcEVBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLFdBQVdBLEVBQUVBLENBQUNBO1lBQ3hCQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxLQUFLQSxFQUFFQSxDQUFDQSxDQUFDQSxRQUFRQSxJQUFJQSxLQUFLQSxHQUFHQSxNQUFNQSxDQUFDQSxHQUFHQSxHQUFHQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxRQUFRQSxHQUFHQSxNQUFNQSxDQUFDQSxHQUFHQSxHQUFHQSxDQUFDQSxDQUFDQSxXQUFXQSxFQUFFQSxHQUFHQSxDQUFDQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQTtRQUNoSEEsQ0FBQ0E7UUFFTUosdUJBQUtBLEdBQVpBO1lBQ0lLLFlBQVlBLENBQUNBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLENBQUNBO1lBQy9CQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQTtnQkFDZEEsTUFBTUEsQ0FBQ0E7WUFDWEEsRUFBRUEsQ0FBQUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsTUFBTUEsSUFBSUEsUUFBUUEsQ0FBQ0E7Z0JBQy9CQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxJQUFJQSxFQUFFQSxDQUFDQSxRQUFRQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQTtZQUN6Q0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsTUFBTUEsRUFBRUEsQ0FBQ0E7WUFDdEJBLElBQUlBLENBQUNBLE9BQU9BLEdBQUdBLElBQUlBLENBQUNBO1lBQ3BCQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxVQUFVQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUNuQ0EsdUJBQWNBLENBQUNBLE1BQU1BLENBQUNBLHVCQUFjQSxDQUFDQSxPQUFPQSxDQUFDQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUMzREEsQ0FBQ0E7UUFDTEwsY0FBQ0E7SUFBREEsQ0FuSEFILEFBbUhDRyxJQUFBSDtJQW5IWUEsZ0JBQU9BLEdBQVBBLE9BbUhaQSxDQUFBQTtBQUNMQSxDQUFDQSxFQWxNTSxPQUFPLEtBQVAsT0FBTyxRQWtNYiIsImZpbGUiOiJuZWF0LXRvb2x0aXAuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLy8gPHJlZmVyZW5jZSBwYXRoPVwidHlwaW5ncy90c2QuZC50c1wiIC8+XHJcblxyXG5cclxuXHJcbm1vZHVsZSBUb29sdGlwIHtcclxuICAgIGV4cG9ydCB2YXIgYWN0aXZlVG9vbHRpcHM6IFRvb2x0aXBbXSA9IFtdO1xyXG5cclxuICAgIGZ1bmN0aW9uIGNsb3NlKCkge1xyXG4gICAgICAgIGZvcih2YXIgaT0wOyBpPGFjdGl2ZVRvb2x0aXBzLmxlbmd0aDsgaSsrKVxyXG4gICAgICAgICAgICBhY3RpdmVUb29sdGlwc1tpXS5jbG9zZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vSW5kaWNhdGVzIGlmIGEganF1ZXJ5IHNldCBjb250YWlucyBhIGdpdmVuIERPTSBub2RlXHJcbiAgICBmdW5jdGlvbiAkY29udGFpbnMoZTogSlF1ZXJ5LCBlbGVtOiBIVE1MRWxlbWVudCwgaW5jbHVkZVNlbGYgPSB0cnVlKSB7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGlmICgoaW5jbHVkZVNlbGYgJiYgZS5nZXQoaSkgPT0gZWxlbSkgfHwgJC5jb250YWlucyhlLmdldChpKSwgZWxlbSkpXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfTtcclxuXHJcbiAgICAoZnVuY3Rpb24gKCQpIHtcclxuXHJcbiAgICAgICAgLy9EaXNwbGF5IGEgdG9vbHRpcCBvbmNlXHJcbiAgICAgICAgJC5mbi5zaG93VG9vbHRpcCA9IGZ1bmN0aW9uIChvcHRpb25zKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgICAgIG5ldyBUb29sdGlwKHRoaXMsIG9wdGlvbnMpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvL0Rpc3BsYXkgYSB0b29sdGlwIG9uY2VcclxuICAgICAgICAkLmZuLmNsb3NlVG9vbHRpcCA9IGZ1bmN0aW9uIChvcHRpb25zKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXtcclxuICAgICAgICAgICAgICAgIHZhciB0ID0gPFRvb2x0aXA+JCh0aGlzKS5kYXRhKCdfdG9vbHRpcCcpO1xyXG4gICAgICAgICAgICAgICAgaWYodClcclxuICAgICAgICAgICAgICAgICAgICB0LmNsb3NlKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8vQmluZCB0b29sdGlwIGRpc3BsYXkgdG8gZXZlbnRcclxuICAgICAgICAkLmZuLnRvb2x0aXAgPSBmdW5jdGlvbiAob3B0aW9ucywgc2hvd09uID0gJ2hvdmVyJywgc2VsZWN0b3I/OnN0cmluZykge1xyXG4gICAgICAgICAgICBpZiAoc2hvd09uID09ICdob3ZlcicpIHtcclxuICAgICAgICAgICAgICAgIHZhciBzaG93ID0gZnVuY3Rpb24gKCkgeyAkKHRoaXMpLnNob3dUb29sdGlwKG9wdGlvbnMpIH07XHJcbiAgICAgICAgICAgICAgICB0aGlzXHJcbiAgICAgICAgICAgICAgICAgICAgLm9uKCdtb3VzZWVudGVyJywgc2VsZWN0b3IsIHNob3cpXHJcbiAgICAgICAgICAgICAgICAgICAgLm9uKCdtb3VzZWxlYXZlJywgc2VsZWN0b3IsIGZ1bmN0aW9uKCl7JCh0aGlzKS5jbG9zZVRvb2x0aXAoKX0pXHJcbiAgICAgICAgICAgICAgICAgICAgLm9uKCdjbGljaycsIHNlbGVjdG9yLCBzaG93KTtcclxuXHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoc2hvd09uID09ICdjbGljaycpe1xyXG4gICAgICAgICAgICAgICAgdGhpcy5vbignY2xpY2snLCBzZWxlY3RvciwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBlID0gJCh0aGlzKTtcclxuICAgICAgICAgICAgICAgICAgICBpZihlLmRhdGEoJ190b29sdGlwJykpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGUuY2xvc2VUb29sdGlwKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlLnNob3dUb29sdGlwKG9wdGlvbnMpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgICAgIHRocm93ICdUaGlzIHZhbHVlIGlzIG5vdCBzdXBwb3J0ZWQgZm9yIGFyZ3VtZW50IHNob3dPbjogJyArIHNob3dPbjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgLy9IaWRlIHRvb2x0aXAgb24gY2xpY2sgb3V0c2lkZSB0YXJnZXQgZWxlbWVudCBhbmQgcG9wdXBcclxuICAgICAgICAkKCdodG1sJykuY2xpY2soZnVuY3Rpb24gKGV2KSB7XHJcbiAgICAgICAgICAgIGZvcih2YXIgaT0wOyBpPGFjdGl2ZVRvb2x0aXBzLmxlbmd0aDsgaSsrKXtcclxuICAgICAgICAgICAgICAgIHZhciB0OlRvb2x0aXAgPSBhY3RpdmVUb29sdGlwc1tpXTtcclxuICAgICAgICAgICAgICAgIHZhciAkYWN0aXZlID0gdC50b29sdGlwLmFkZCh0LnRhcmdldCk7XHJcbiAgICAgICAgICAgICAgICBpZiAodCAmJiB0Lm9wdGlvbnMuY2xvc2VPbkNsaWNrT3VzaWRlICYmICEkY29udGFpbnMoJGFjdGl2ZSwgZXYudGFyZ2V0KSlcclxuICAgICAgICAgICAgICAgICAgICB0LmNsb3NlKCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICQod2luZG93KS5yZXNpemUoKCkgPT4ge1xyXG4gICAgICAgICAgICBmb3IodmFyIGk9MDsgaTxhY3RpdmVUb29sdGlwcy5sZW5ndGg7IGkrKyl7XHJcbiAgICAgICAgICAgICAgICBhY3RpdmVUb29sdGlwc1tpXS5wb3NpdGlvbigpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KShqUXVlcnkpO1xyXG5cclxuICAgIGV4cG9ydCBjbGFzcyBUb29sdGlwIHtcclxuICAgICAgICBwdWJsaWMgdG9vbHRpcDogSlF1ZXJ5O1xyXG4gICAgICAgIHB1YmxpYyB0YXJnZXQ6IEpRdWVyeTtcclxuICAgICAgICBwdWJsaWMgY29udGVudDogSlF1ZXJ5O1xyXG4gICAgICAgIHByaXZhdGUgY2xvc2VDYWxsYmFjayA9ICgpID0+IHsgdGhpcy5jbG9zZSgpOyByZXR1cm4gZmFsc2U7IH07XHJcbiAgICAgICAgcHJpdmF0ZSBzaG93VGltZW91dDtcclxuXHJcbiAgICAgICAgY29uc3RydWN0b3IocHJpdmF0ZSB0YXJnZXRFbGVtOiBIVE1MRWxlbWVudCwgcHVibGljIG9wdGlvbnM6IHRvb2x0aXBfb3B0aW9ucykge1xyXG4gICAgICAgICAgICB0aGlzLm9wdGlvbnMgPSAkLmV4dGVuZCh7XHJcbiAgICAgICAgICAgICAgICBwb3NpdGlvbjogJ2JvdHRvbScsXHJcbiAgICAgICAgICAgICAgICBzb3VyY2U6ICd0aXRsZScsXHJcbiAgICAgICAgICAgICAgICBjc3NDbGFzczogJycsXHJcbiAgICAgICAgICAgICAgICBjbG9zZVNlbGVjdG9yOiAnLnRvb2x0aXAtY2xvc2UnLFxyXG4gICAgICAgICAgICAgICAgZGlzdGFuY2U6IDUsXHJcbiAgICAgICAgICAgICAgICBhbGxvd011bHRpcGxlOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIGNsb3NlT25DbGlja091c2lkZTogdHJ1ZSxcclxuICAgICAgICAgICAgICAgIGRlbGF5OiAyMDAsXHJcbiAgICAgICAgICAgICAgICBjb250YWluZXI6IHdpbmRvdyxcclxuICAgICAgICAgICAgICAgIG1hcmdpbjogMTAsXHJcbiAgICAgICAgICAgIH0sIG9wdGlvbnMpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy50YXJnZXQgPSAkKHRhcmdldEVsZW0pLmFkZENsYXNzKCdoYXMtdG9vbHRpcCcpLmNsb3NlVG9vbHRpcCgpLmRhdGEoJ190b29sdGlwJywgdGhpcyk7XHJcbiAgICAgICAgICAgIHRoaXMuc2hvd1RpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHRoaXMuc2hvdygpLCB0aGlzLm9wdGlvbnMuZGVsYXkpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcHJpdmF0ZSBnZXRDb250ZW50KCk6IEpRdWVyeSB7XHJcbiAgICAgICAgICAgIHZhciBjID0gdGhpcy5vcHRpb25zLmNvbnRlbnQ7XHJcbiAgICAgICAgICAgIGlmIChjKSB7XHJcbiAgICAgICAgICAgICAgICBjID0gJC5pc0Z1bmN0aW9uKGMpID8gYy5jYWxsKHRoaXMudGFyZ2V0KSA6IGM7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gIWMgPyBudWxsIDogdHlwZW9mIGMgPT0gJ3N0cmluZycgPyAgJCgnPGRpdj4nKS5odG1sKGMpIDogJChjKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLnNvdXJjZSA9PSAndGl0bGUnKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgdGl0bGUgPSB0aGlzLnRhcmdldC5hdHRyKCd0aXRsZScpIHx8IHRoaXMudGFyZ2V0LmRhdGEoJ3RpdGxlJyk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldC5hdHRyKCd0aXRsZScsICcnKS5kYXRhKCd0aXRsZScsIHRpdGxlKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiAkKCc8ZGl2PicpLmh0bWwodGl0bGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuc291cmNlID09ICdhbmNob3InKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgY29udGVudCA9ICQodGhpcy50YXJnZXQuYXR0cignaHJlZicpKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBjb250ZW50Lmxlbmd0aCA/IGNvbnRlbnQgOiBudWxsO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwcml2YXRlIHNob3coKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29udGVudCA9IHRoaXMuZ2V0Q29udGVudCgpO1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuY29udGVudClcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuXHJcbiAgICAgICAgICAgIGlmKCF0aGlzLm9wdGlvbnMuYWxsb3dNdWx0aXBsZSlcclxuICAgICAgICAgICAgICAgIGNsb3NlKCk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmNvbnRlbnRcclxuICAgICAgICAgICAgICAgIC5vZmYoJ2NsaWNrJywgdGhpcy5jbG9zZUNhbGxiYWNrKVxyXG4gICAgICAgICAgICAgICAgLm9uKCdjbGljaycsIHRoaXMub3B0aW9ucy5jbG9zZVNlbGVjdG9yLCB0aGlzLmNsb3NlQ2FsbGJhY2spO1xyXG5cclxuICAgICAgICAgICAgdmFyIG8gPSB0aGlzLm9wdGlvbnM7XHJcblxyXG4gICAgICAgICAgICB0aGlzLnRvb2x0aXAgPSAkKCc8ZGl2IGNsYXNzPVwidG9vbHRpcC1mcmFtZVwiLz4nKVxyXG4gICAgICAgICAgICAgICAgLmFkZENsYXNzKG8uY3NzQ2xhc3MpXHJcbiAgICAgICAgICAgICAgICAuYWRkQ2xhc3MoJ3Rvb2x0aXAtJyArIG8ucG9zaXRpb24pXHJcbiAgICAgICAgICAgICAgICAuYXBwZW5kKHRoaXMuY29udGVudC5zaG93KCkpXHJcbiAgICAgICAgICAgICAgICAuYXBwZW5kKCQoJzxkaXYgY2xhc3M9XCJ0aXBcIi8+JykpXHJcbiAgICAgICAgICAgICAgICAuYXBwZW5kVG8oJ2JvZHknKTtcclxuXHJcbiAgICAgICAgICAgIGFjdGl2ZVRvb2x0aXBzLnB1c2godGhpcyk7XHJcbiAgICAgICAgICAgIHRoaXMucG9zaXRpb24oKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHB1YmxpYyBwb3NpdGlvbigpIHtcclxuICAgICAgICAgICAgdmFyIG1hcmdpbiA9IHRoaXMub3B0aW9ucy5tYXJnaW47XHJcblxyXG4gICAgICAgICAgICB2YXIgdCA9IHRoaXMudG9vbHRpcDtcclxuICAgICAgICAgICAgdmFyIGUgPSB0aGlzLnRhcmdldDtcclxuICAgICAgICAgICAgdmFyIG8gPSB0aGlzLm9wdGlvbnM7XHJcblxyXG4gICAgICAgICAgICBpZiAoIXQpXHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcblxyXG4gICAgICAgICAgICAvL1Jlc2V0IHNvIGRpbWVudGlvbnMgY2FsY3VsYXRpb25zIGFyZSBjb3JyZWN0XHJcbiAgICAgICAgICAgIHQucmVtb3ZlQXR0cignc3R5bGUnKTtcclxuICAgICAgICAgICAgdmFyIG9mZnNldCA9IGUub2Zmc2V0KCk7XHJcbiAgICAgICAgICAgIHZhciBjb250YWluZXIgPSB0aGlzLm9wdGlvbnMuY29udGFpbmVyO1xyXG4gICAgICAgICAgICB2YXIgY29udGFpbmVyTGVmdCA9IGNvbnRhaW5lciA9PT0gd2luZG93ID8gMCA6ICQoY29udGFpbmVyKS5vZmZzZXQoKS5sZWZ0XHJcbiAgICAgICAgICAgIHZhciBtaW5MZWZ0ID0gY29udGFpbmVyTGVmdCArIG1hcmdpbjtcclxuICAgICAgICAgICAgdmFyIG1heFJpZ2h0ID0gKGNvbnRhaW5lckxlZnQgKyAkKGNvbnRhaW5lcikub3V0ZXJXaWR0aCgpKSAtIG1hcmdpbjtcclxuXHJcbiAgICAgICAgICAgIHZhciB3ID0gdC5vdXRlcldpZHRoKCk7XHJcblxyXG4gICAgICAgICAgICB2YXIgbGVmdCA9IE1hdGgubWF4KG1pbkxlZnQsIG9mZnNldC5sZWZ0ICsgZS5vdXRlcldpZHRoKCkgLyAyIC0gdyAvIDIpO1xyXG5cclxuICAgICAgICAgICAgdmFyIHJpZ2h0T3ZlcmZsb3cgPSAobGVmdCArIHcpIC0gbWF4UmlnaHQ7XHJcbiAgICAgICAgICAgIGlmKHJpZ2h0T3ZlcmZsb3cgPiAwKVxyXG4gICAgICAgICAgICAgICAgbGVmdCA9IE1hdGgubWF4KG1pbkxlZnQsIGxlZnQgLSByaWdodE92ZXJmbG93KVxyXG5cclxuICAgICAgICAgICAgdC5jc3Moe1xyXG4gICAgICAgICAgICAgICAgJ2xlZnQnOiBsZWZ0ICsgJ3B4JyxcclxuICAgICAgICAgICAgICAgICdtYXgtd2lkdGgnOiAobWF4UmlnaHQgLSBsZWZ0KSArICdweCdcclxuICAgICAgICAgICAgfSkuZmluZCgnLnRpcCcpLmNzcygnbGVmdCcsIG9mZnNldC5sZWZ0ICsgZS5vdXRlcldpZHRoKCkgLyAyIC0gbGVmdCArICdweCcpO1xyXG4gICAgICAgICAgICAvL1NldHRpbmcgd2lkdGggY2FuIG1ha2UgaGVpZ2h0IHZhcnkuIFNvIHdlIHNldCB2ZXJ0aWNhbCBwb3NpdGlvbiBhZnRlci5cclxuICAgICAgICAgICAgdmFyIGggPSB0Lm91dGVySGVpZ2h0KCk7XHJcbiAgICAgICAgICAgIHQuY3NzKCd0b3AnLCBvLnBvc2l0aW9uID09ICd0b3AnID8gb2Zmc2V0LnRvcCAtIGggLSBvLmRpc3RhbmNlIDogb2Zmc2V0LnRvcCArIGUub3V0ZXJIZWlnaHQoKSArIG8uZGlzdGFuY2UpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcHVibGljIGNsb3NlKCkge1xyXG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5zaG93VGltZW91dCk7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy50b29sdGlwKVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICBpZih0aGlzLm9wdGlvbnMuc291cmNlID09ICdhbmNob3InKVxyXG4gICAgICAgICAgICAgICAgdGhpcy5jb250ZW50LmhpZGUoKS5hcHBlbmRUbygnYm9keScpO1xyXG4gICAgICAgICAgICB0aGlzLnRvb2x0aXAucmVtb3ZlKCk7XHJcbiAgICAgICAgICAgIHRoaXMudG9vbHRpcCA9IG51bGw7XHJcbiAgICAgICAgICAgIHRoaXMudGFyZ2V0LmRhdGEoJ190b29sdGlwJywgbnVsbCk7XHJcbiAgICAgICAgICAgIGFjdGl2ZVRvb2x0aXBzLnNwbGljZShhY3RpdmVUb29sdGlwcy5pbmRleE9mKHRoaXMpLCAxKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn0iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=