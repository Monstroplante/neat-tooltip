/// <reference path="typings/tsd.d.ts" />
var Tooltip;
(function (_Tooltip) {
    _Tooltip.activeTooltips = [];
    (function (Position) {
        Position[Position["bottom"] = 0] = "bottom";
        Position[Position["top"] = 1] = "top";
    })(_Tooltip.Position || (_Tooltip.Position = {}));
    var Position = _Tooltip.Position;
    (function (Source) {
        //Get tooltip content from title attribute
        Source[Source["title"] = 0] = "title";
        // Get tooltip content from anchor attribute. If anchor starts with #, will searh for element on the page.
        // Else (not yet supported), will load URL
        Source[Source["anchor"] = 1] = "anchor";
    })(_Tooltip.Source || (_Tooltip.Source = {}));
    var Source = _Tooltip.Source;
    (function (ShowOn) {
        ShowOn[ShowOn["hover"] = 0] = "hover";
        ShowOn[ShowOn["click"] = 1] = "click";
    })(_Tooltip.ShowOn || (_Tooltip.ShowOn = {}));
    var ShowOn = _Tooltip.ShowOn;
    function close() {
        for (var i = 0; i < _Tooltip.activeTooltips.length; i++)
            _Tooltip.activeTooltips[i].close();
    }
    //Indicates if a jquery set contains a given DOM node
    function $contains(e, elem, includeSelf) {
        if (includeSelf === void 0) { includeSelf = true; }
        for (var i = 0; i < e.length; i++) {
            if ((includeSelf && e.get(i) == elem) || $.contains(e.get(i), elem))
                return true;
        }
        return false;
    }
    ;
    (function ($) {
        //Display a tooltip once
        $.fn.showTooltip = function (options) {
            return this.each(function () {
                new Tooltip(this, options);
            });
        };
        //Display a tooltip once
        $.fn.closeTooltip = function (options) {
            return this.each(function () {
                var t = $(this).data('tooltip');
                if (t)
                    t.close();
            });
        };
        //Bind tooltip display to event
        $.fn.tooltip = function (options, showOn) {
            if (showOn === void 0) { showOn = 0 /* hover */; }
            if (showOn == 0 /* hover */) {
                var show = function () {
                    $(this).showTooltip(options);
                };
                this.hover(show, function () {
                    $(this).closeTooltip();
                }).click(show);
            }
            else if (showOn == 1 /* click */) {
                this.click(function () {
                    var e = $(this);
                    console.log(e.data('tooltip'));
                    if (e.data('tooltip'))
                        e.closeTooltip();
                    else
                        e.showTooltip(options);
                    return false;
                });
            }
            return this;
        };
        //Hide tooltip on click outside target element and popup
        $('html').click(function (ev) {
            for (var i = 0; i < _Tooltip.activeTooltips.length; i++) {
                var t = _Tooltip.activeTooltips[i];
                var $active = t.tooltip.add(t.target);
                if (t && !$contains($active, ev.target))
                    t.close();
            }
        });
        $(window).resize(function () {
            for (var i = 0; i < _Tooltip.activeTooltips.length; i++) {
                _Tooltip.activeTooltips[i].position();
            }
        });
    })(jQuery);
    var Tooltip = (function () {
        function Tooltip(targetElem, options) {
            var _this = this;
            this.targetElem = targetElem;
            this.options = options;
            this.closeCallback = function () {
                _this.close();
                return false;
            };
            this.options = $.extend({
                position: 0 /* bottom */,
                source: 0 /* title */,
                cssClass: '',
                closeSelector: '.tooltip-close',
                distance: 5,
                allowMultiple: false
            }, options);
            this.target = $(targetElem).addClass('has-tooltip').closeTooltip().data('tooltip', this);
            this.show();
        }
        Tooltip.prototype.getContent = function () {
            var c = this.options.content;
            if (c) {
                c = $.isFunction(c) ? c() : c;
                return typeof c == 'string' ? $('<div>').html(c) : $(c);
            }
            if (this.options.source == 0 /* title */) {
                var title = this.target.attr('title') || this.target.data('title');
                this.target.attr('title', '').data('title', title);
                return $('<div>').html(title);
            }
            if (this.options.source == 1 /* anchor */) {
                var content = $(this.target.attr('href'));
                return content.length ? content : null;
            }
        };
        Tooltip.prototype.toggle = function () {
            if (this.tooltip)
                this.close();
            else
                this.show();
        };
        Tooltip.prototype.show = function () {
            this.content = this.getContent();
            if (!this.content)
                return;
            if (!this.options.allowMultiple)
                close();
            this.content.off('click', this.closeCallback).on('click', this.options.closeSelector, this.closeCallback);
            var o = this.options;
            this.tooltip = $('<div class="tooltip-frame"/>').addClass(o.cssClass).addClass('tooltip-' + Position[o.position]).append(this.content.show()).append($('<div class="tip"/>')).appendTo('body');
            _Tooltip.activeTooltips.push(this);
            this.position();
        };
        Tooltip.prototype.position = function () {
            var margin = 10;
            var t = this.tooltip;
            var e = this.target;
            var o = this.options;
            if (!t)
                return;
            //Reset so dimentions calculations are correct
            t.removeAttr('style');
            var offset = e.offset();
            var ww = $(window).width();
            var w = t.outerWidth();
            var left = offset.left + e.outerWidth() / 2 - w / 2;
            if (left < margin)
                left = margin;
            var rightOverflow = (left + w) - (ww - margin);
            if (rightOverflow > 0)
                left = Math.max(left - rightOverflow, margin);
            t.css({
                'left': left + 'px',
                'max-width': (ww - left - margin) + 'px'
            }).find('.tip').css('left', offset.left + e.outerWidth() / 2 - left + 'px');
            //Setting width can make height vary. So we set vertical position after.
            var h = t.outerHeight();
            t.css('top', o.position == 1 /* top */ ? offset.top - h - o.distance : offset.top + e.outerHeight() + o.distance);
        };
        Tooltip.prototype.close = function () {
            console.log('close22');
            if (!this.tooltip)
                return;
            if (this.options.source == 1 /* anchor */)
                this.content.hide().appendTo('body');
            this.tooltip.remove();
            this.tooltip = null;
            this.target.data('tooltip', null);
            _Tooltip.activeTooltips.splice(_Tooltip.activeTooltips.indexOf(this), 1);
        };
        return Tooltip;
    })();
    _Tooltip.Tooltip = Tooltip;
})(Tooltip || (Tooltip = {}));

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5lYXQtdG9vbHRpcC50cyJdLCJuYW1lcyI6WyJUb29sdGlwIiwiVG9vbHRpcC5Qb3NpdGlvbiIsIlRvb2x0aXAuU291cmNlIiwiVG9vbHRpcC5TaG93T24iLCJUb29sdGlwLmNsb3NlIiwiVG9vbHRpcC4kY29udGFpbnMiLCJUb29sdGlwLlRvb2x0aXAiLCJUb29sdGlwLlRvb2x0aXAuY29uc3RydWN0b3IiLCJUb29sdGlwLlRvb2x0aXAuZ2V0Q29udGVudCIsIlRvb2x0aXAuVG9vbHRpcC50b2dnbGUiLCJUb29sdGlwLlRvb2x0aXAuc2hvdyIsIlRvb2x0aXAuVG9vbHRpcC5wb3NpdGlvbiIsIlRvb2x0aXAuVG9vbHRpcC5jbG9zZSJdLCJtYXBwaW5ncyI6IkFBQUEseUNBQXlDO0FBd0J6QyxJQUFPLE9BQU8sQ0ErTWI7QUEvTUQsV0FBTyxRQUFPLEVBQUMsQ0FBQztJQUNEQSx1QkFBY0EsR0FBY0EsRUFBRUEsQ0FBQ0E7SUFDMUNBLFdBQVlBLFFBQVFBO1FBQUdDLDJDQUFNQTtRQUFFQSxxQ0FBR0E7SUFBQ0EsQ0FBQ0EsRUFBeEJELGlCQUFRQSxLQUFSQSxpQkFBUUEsUUFBZ0JBO0lBQXBDQSxJQUFZQSxRQUFRQSxHQUFSQSxpQkFBd0JBLENBQUFBO0lBQ3BDQSxXQUFZQSxNQUFNQTtRQUNkRSwwQ0FBMENBO1FBQzFDQSxxQ0FBS0E7UUFDTEEsMEdBQTBHQTtRQUMxR0EsMENBQTBDQTtRQUMxQ0EsdUNBQU1BO0lBQ1ZBLENBQUNBLEVBTldGLGVBQU1BLEtBQU5BLGVBQU1BLFFBTWpCQTtJQU5EQSxJQUFZQSxNQUFNQSxHQUFOQSxlQU1YQSxDQUFBQTtJQUNEQSxXQUFZQSxNQUFNQTtRQUFHRyxxQ0FBS0E7UUFBRUEscUNBQUtBO0lBQUNBLENBQUNBLEVBQXZCSCxlQUFNQSxLQUFOQSxlQUFNQSxRQUFpQkE7SUFBbkNBLElBQVlBLE1BQU1BLEdBQU5BLGVBQXVCQSxDQUFBQTtJQUVuQ0EsU0FBU0EsS0FBS0E7UUFDVkksR0FBR0EsQ0FBQUEsQ0FBQ0Es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Q0FBQ0EsSUFBSUEsUUFBUUEsR0FBSUEsQ0FBQ0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDN0RBLENBQUNBO1lBR0RBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLE1BQU1BLElBQUlBLGFBQVlBLENBQUNBLENBQUNBLENBQUNBO2dCQUN0Q0EsSUFBSUEsS0FBS0EsR0FBR0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsSUFBSUEsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ25FQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxFQUFFQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxFQUFFQSxLQUFLQSxDQUFDQSxDQUFDQTtnQkFDbkRBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBO1lBQ2xDQSxDQUFDQTtZQUNEQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxNQUFNQSxJQUFJQSxjQUFhQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDdkNBLElBQUlBLE9BQU9BLEdBQUdBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBO2dCQUMxQ0EsTUFBTUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsTUFBTUEsR0FBR0EsT0FBT0EsR0FBR0EsSUFBSUEsQ0FBQ0E7WUFDM0NBLENBQUNBO1FBQ0xBLENBQUNBO1FBRU1GLHdCQUFNQSxHQUFiQTtZQUNJRyxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQTtnQkFD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RUEsQ0FBQUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsTUFBTUEsSUFBSUEsY0FBYUEsQ0FBQ0E7Z0JBQ3BDQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxJQUFJQSxFQUFFQSxDQUFDQSxRQUFRQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQTtZQUN6Q0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsTUFBTUEsRUFBRUEsQ0FBQ0E7WUFDdEJBLElBQUlBLENBQUNBLE9BQU9BLEdBQUdBLElBQUlBLENBQUNBO1lBQ3BCQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxTQUFTQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUNsQ0EsdUJBQWNBLENBQUNBLE1BQU1BLENBQUNBLHVCQUFjQSxDQUFDQSxPQUFPQSxDQUFDQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUMzREEsQ0FBQ0E7UUFDTE4sY0FBQ0E7SUFBREEsQ0F6SEFOLEFBeUhDTSxJQUFBTjtJQXpIWUEsZ0JBQU9BLEdBQVBBLE9BeUhaQSxDQUFBQTtBQUNMQSxDQUFDQSxFQS9NTSxPQUFPLEtBQVAsT0FBTyxRQStNYiIsImZpbGUiOiJuZWF0LXRvb2x0aXAuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLy8gPHJlZmVyZW5jZSBwYXRoPVwidHlwaW5ncy90c2QuZC50c1wiIC8+XHJcblxyXG5pbnRlcmZhY2UgdG9vbHRpcF9vcHRpb25zIHtcclxuICAgIHBvc2l0aW9uPzogVG9vbHRpcC5Qb3NpdGlvbjtcclxuICAgIHNvdXJjZT86IFRvb2x0aXAuU291cmNlO1xyXG4gICAgY3NzQ2xhc3M/OiBzdHJpbmc7XHJcbiAgICBjbG9zZVNlbGVjdG9yPzogc3RyaW5nO1xyXG4gICAgZGlzdGFuY2U/OiBudW1iZXI7XHJcblxyXG4gICAgLy9JZiBmYWxzZSAoZGVmYXVsdCksIGNsb3NlIGFueSBvdGhlciB2aXNpYmxlIHRvb2x0aXAgb24gZGlzcGxheVxyXG4gICAgYWxsb3dNdWx0aXBsZT86IGJvb2xlYW47XHJcblxyXG4gICAgLy9DYW4gYmUgYW4gSFRNTCBzdHJpbmcsIGFuIGVsZW1lbnQgb3IgYSBKUXVlcnkgb2JqZWN0XHJcbiAgICAvL0NhbiBhbHNvIGJlIGEgZnVuY3Rpb24gcmV0dXJuaW5nIHRoZSBzYW1lIHZhbHVlIHR5cGUgKHRoaXMgcmVmZXIgdG8gdGhlIHRhcmdldCBlbGVtZW50KS5cclxuICAgIC8vSWYgc2V0LCBzb3VyY2UgaXMgaWdub3JlZC5cclxuICAgIGNvbnRlbnQ/OiBhbnk7XHJcbn1cclxuXHJcbmludGVyZmFjZSBKUXVlcnkge1xyXG4gICAgdG9vbHRpcChvcHRpb25zPzogdG9vbHRpcF9vcHRpb25zLCBzaG93T24/OlRvb2x0aXAuU2hvd09uKTogSlF1ZXJ5O1xyXG4gICAgc2hvd1Rvb2x0aXAob3B0aW9ucz86IHRvb2x0aXBfb3B0aW9ucyk6IFRvb2x0aXAuVG9vbHRpcDtcclxuICAgIGNsb3NlVG9vbHRpcCgpOiBKUXVlcnk7XHJcbn1cclxuXHJcbm1vZHVsZSBUb29sdGlwIHtcclxuICAgIGV4cG9ydCB2YXIgYWN0aXZlVG9vbHRpcHM6IFRvb2x0aXBbXSA9IFtdO1xyXG4gICAgZXhwb3J0IGVudW0gUG9zaXRpb24geyBib3R0b20sIHRvcCB9XHJcbiAgICBleHBvcnQgZW51bSBTb3VyY2Uge1xyXG4gICAgICAgIC8vR2V0IHRvb2x0aXAgY29udGVudCBmcm9tIHRpdGxlIGF0dHJpYnV0ZVxyXG4gICAgICAgIHRpdGxlLFxyXG4gICAgICAgIC8vIEdldCB0b29sdGlwIGNvbnRlbnQgZnJvbSBhbmNob3IgYXR0cmlidXRlLiBJZiBhbmNob3Igc3RhcnRzIHdpdGggIywgd2lsbCBzZWFyaCBmb3IgZWxlbWVudCBvbiB0aGUgcGFnZS5cclxuICAgICAgICAvLyBFbHNlIChub3QgeWV0IHN1cHBvcnRlZCksIHdpbGwgbG9hZCBVUkxcclxuICAgICAgICBhbmNob3JcclxuICAgIH1cclxuICAgIGV4cG9ydCBlbnVtIFNob3dPbiB7IGhvdmVyLCBjbGljayB9XHJcblxyXG4gICAgZnVuY3Rpb24gY2xvc2UoKSB7XHJcbiAgICAgICAgZm9yKHZhciBpPTA7IGk8YWN0aXZlVG9vbHRpcHMubGVuZ3RoOyBpKyspXHJcbiAgICAgICAgICAgIGFjdGl2ZVRvb2x0aXBzW2ldLmNsb3NlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgLy9JbmRpY2F0ZXMgaWYgYSBqcXVlcnkgc2V0IGNvbnRhaW5zIGEgZ2l2ZW4gRE9NIG5vZGVcclxuICAgIGZ1bmN0aW9uICRjb250YWlucyhlOiBKUXVlcnksIGVsZW06IEhUTUxFbGVtZW50LCBpbmNsdWRlU2VsZiA9IHRydWUpIHtcclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGUubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgaWYgKChpbmNsdWRlU2VsZiAmJiBlLmdldChpKSA9PSBlbGVtKSB8fCAkLmNvbnRhaW5zKGUuZ2V0KGkpLCBlbGVtKSlcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9O1xyXG5cclxuICAgIChmdW5jdGlvbiAoJCkge1xyXG5cclxuICAgICAgICAvL0Rpc3BsYXkgYSB0b29sdGlwIG9uY2VcclxuICAgICAgICAkLmZuLnNob3dUb29sdGlwID0gZnVuY3Rpb24gKG9wdGlvbnMpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICAgICAgbmV3IFRvb2x0aXAodGhpcywgb3B0aW9ucyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8vRGlzcGxheSBhIHRvb2x0aXAgb25jZVxyXG4gICAgICAgICQuZm4uY2xvc2VUb29sdGlwID0gZnVuY3Rpb24gKG9wdGlvbnMpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICAgICAgdmFyIHQgPSA8VG9vbHRpcD4kKHRoaXMpLmRhdGEoJ3Rvb2x0aXAnKTtcclxuICAgICAgICAgICAgICAgIGlmKHQpXHJcbiAgICAgICAgICAgICAgICAgICAgdC5jbG9zZSgpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvL0JpbmQgdG9vbHRpcCBkaXNwbGF5IHRvIGV2ZW50XHJcbiAgICAgICAgJC5mbi50b29sdGlwID0gZnVuY3Rpb24gKG9wdGlvbnMsIHNob3dPbiA9IFNob3dPbi5ob3Zlcikge1xyXG4gICAgICAgICAgICBpZiAoc2hvd09uID09IFNob3dPbi5ob3Zlcikge1xyXG4gICAgICAgICAgICAgICAgdmFyIHNob3cgPSBmdW5jdGlvbiAoKSB7ICQodGhpcykuc2hvd1Rvb2x0aXAob3B0aW9ucykgfTtcclxuICAgICAgICAgICAgICAgIHRoaXMuaG92ZXIoXHJcbiAgICAgICAgICAgICAgICAgICAgc2hvdyxcclxuICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbigpeyQodGhpcykuY2xvc2VUb29sdGlwKCl9XHJcbiAgICAgICAgICAgICAgICApLmNsaWNrKHNob3cpO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHNob3dPbiA9PSBTaG93T24uY2xpY2spe1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jbGljayhmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGUgPSAkKHRoaXMpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGUuZGF0YSgndG9vbHRpcCcpKTtcclxuICAgICAgICAgICAgICAgICAgICBpZihlLmRhdGEoJ3Rvb2x0aXAnKSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgZS5jbG9zZVRvb2x0aXAoKTtcclxuICAgICAgICAgICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGUuc2hvd1Rvb2x0aXAob3B0aW9ucyk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8vSGlkZSB0b29sdGlwIG9uIGNsaWNrIG91dHNpZGUgdGFyZ2V0IGVsZW1lbnQgYW5kIHBvcHVwXHJcbiAgICAgICAgJCgnaHRtbCcpLmNsaWNrKGZ1bmN0aW9uIChldikge1xyXG4gICAgICAgICAgICBmb3IodmFyIGk9MDsgaTxhY3RpdmVUb29sdGlwcy5sZW5ndGg7IGkrKyl7XHJcbiAgICAgICAgICAgICAgICB2YXIgdDpUb29sdGlwID0gYWN0aXZlVG9vbHRpcHNbaV07XHJcbiAgICAgICAgICAgICAgICB2YXIgJGFjdGl2ZSA9IHQudG9vbHRpcC5hZGQodC50YXJnZXQpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHQgJiYgISRjb250YWlucygkYWN0aXZlLCBldi50YXJnZXQpKVxyXG4gICAgICAgICAgICAgICAgICAgIHQuY2xvc2UoKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgJCh3aW5kb3cpLnJlc2l6ZSgoKSA9PiB7XHJcbiAgICAgICAgICAgIGZvcih2YXIgaT0wOyBpPGFjdGl2ZVRvb2x0aXBzLmxlbmd0aDsgaSsrKXtcclxuICAgICAgICAgICAgICAgIGFjdGl2ZVRvb2x0aXBzW2ldLnBvc2l0aW9uKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH0pKGpRdWVyeSk7XHJcblxyXG4gICAgZXhwb3J0IGNsYXNzIFRvb2x0aXAge1xyXG4gICAgICAgIHB1YmxpYyB0b29sdGlwOiBKUXVlcnk7XHJcbiAgICAgICAgcHVibGljIHRhcmdldDogSlF1ZXJ5O1xyXG4gICAgICAgIHB1YmxpYyBjb250ZW50OiBKUXVlcnk7XHJcbiAgICAgICAgcHJpdmF0ZSBjbG9zZUNhbGxiYWNrID0gKCkgPT4geyB0aGlzLmNsb3NlKCk7IHJldHVybiBmYWxzZTsgfTtcclxuXHJcbiAgICAgICAgY29uc3RydWN0b3IocHJpdmF0ZSB0YXJnZXRFbGVtOiBIVE1MRWxlbWVudCwgcHJpdmF0ZSBvcHRpb25zOiB0b29sdGlwX29wdGlvbnMpIHtcclxuICAgICAgICAgICAgdGhpcy5vcHRpb25zID0gJC5leHRlbmQoe1xyXG4gICAgICAgICAgICAgICAgcG9zaXRpb246IFBvc2l0aW9uLmJvdHRvbSxcclxuICAgICAgICAgICAgICAgIHNvdXJjZTogU291cmNlLnRpdGxlLFxyXG4gICAgICAgICAgICAgICAgY3NzQ2xhc3M6ICcnLFxyXG4gICAgICAgICAgICAgICAgY2xvc2VTZWxlY3RvcjogJy50b29sdGlwLWNsb3NlJyxcclxuICAgICAgICAgICAgICAgIGRpc3RhbmNlOiA1LFxyXG4gICAgICAgICAgICAgICAgYWxsb3dNdWx0aXBsZTogZmFsc2UsXHJcbiAgICAgICAgICAgIH0sIG9wdGlvbnMpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy50YXJnZXQgPSAkKHRhcmdldEVsZW0pLmFkZENsYXNzKCdoYXMtdG9vbHRpcCcpLmNsb3NlVG9vbHRpcCgpLmRhdGEoJ3Rvb2x0aXAnLCB0aGlzKTtcclxuICAgICAgICAgICAgdGhpcy5zaG93KCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwcml2YXRlIGdldENvbnRlbnQoKTogSlF1ZXJ5IHtcclxuICAgICAgICAgICAgdmFyIGMgPSB0aGlzLm9wdGlvbnMuY29udGVudDtcclxuICAgICAgICAgICAgaWYgKGMpIHtcclxuICAgICAgICAgICAgICAgIGMgPSAkLmlzRnVuY3Rpb24oYykgPyBjKCkgOiBjO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBjID09ICdzdHJpbmcnID8gICQoJzxkaXY+JykuaHRtbChjKSA6ICQoYyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5zb3VyY2UgPT0gU291cmNlLnRpdGxlKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgdGl0bGUgPSB0aGlzLnRhcmdldC5hdHRyKCd0aXRsZScpIHx8IHRoaXMudGFyZ2V0LmRhdGEoJ3RpdGxlJyk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldC5hdHRyKCd0aXRsZScsICcnKS5kYXRhKCd0aXRsZScsIHRpdGxlKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiAkKCc8ZGl2PicpLmh0bWwodGl0bGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuc291cmNlID09IFNvdXJjZS5hbmNob3IpIHtcclxuICAgICAgICAgICAgICAgIHZhciBjb250ZW50ID0gJCh0aGlzLnRhcmdldC5hdHRyKCdocmVmJykpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRlbnQubGVuZ3RoID8gY29udGVudCA6IG51bGw7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHB1YmxpYyB0b2dnbGUoKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnRvb2x0aXApXHJcbiAgICAgICAgICAgICAgICB0aGlzLmNsb3NlKCk7XHJcbiAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgIHRoaXMuc2hvdygpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcHVibGljIHNob3coKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29udGVudCA9IHRoaXMuZ2V0Q29udGVudCgpO1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuY29udGVudClcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuXHJcbiAgICAgICAgICAgIGlmKCF0aGlzLm9wdGlvbnMuYWxsb3dNdWx0aXBsZSlcclxuICAgICAgICAgICAgICAgIGNsb3NlKCk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmNvbnRlbnRcclxuICAgICAgICAgICAgICAgIC5vZmYoJ2NsaWNrJywgdGhpcy5jbG9zZUNhbGxiYWNrKVxyXG4gICAgICAgICAgICAgICAgLm9uKCdjbGljaycsIHRoaXMub3B0aW9ucy5jbG9zZVNlbGVjdG9yLCB0aGlzLmNsb3NlQ2FsbGJhY2spO1xyXG5cclxuICAgICAgICAgICAgdmFyIG8gPSB0aGlzLm9wdGlvbnM7XHJcblxyXG4gICAgICAgICAgICB0aGlzLnRvb2x0aXAgPSAkKCc8ZGl2IGNsYXNzPVwidG9vbHRpcC1mcmFtZVwiLz4nKVxyXG4gICAgICAgICAgICAgICAgLmFkZENsYXNzKG8uY3NzQ2xhc3MpXHJcbiAgICAgICAgICAgICAgICAuYWRkQ2xhc3MoJ3Rvb2x0aXAtJyArIFBvc2l0aW9uW28ucG9zaXRpb25dKVxyXG4gICAgICAgICAgICAgICAgLmFwcGVuZCh0aGlzLmNvbnRlbnQuc2hvdygpKVxyXG4gICAgICAgICAgICAgICAgLmFwcGVuZCgkKCc8ZGl2IGNsYXNzPVwidGlwXCIvPicpKVxyXG4gICAgICAgICAgICAgICAgLmFwcGVuZFRvKCdib2R5Jyk7XHJcblxyXG4gICAgICAgICAgICBhY3RpdmVUb29sdGlwcy5wdXNoKHRoaXMpO1xyXG4gICAgICAgICAgICB0aGlzLnBvc2l0aW9uKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwdWJsaWMgcG9zaXRpb24oKSB7XHJcbiAgICAgICAgICAgIHZhciBtYXJnaW4gPSAxMDtcclxuXHJcbiAgICAgICAgICAgIHZhciB0ID0gdGhpcy50b29sdGlwO1xyXG4gICAgICAgICAgICB2YXIgZSA9IHRoaXMudGFyZ2V0O1xyXG4gICAgICAgICAgICB2YXIgbyA9IHRoaXMub3B0aW9ucztcclxuXHJcbiAgICAgICAgICAgIGlmICghdClcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuXHJcbiAgICAgICAgICAgIC8vUmVzZXQgc28gZGltZW50aW9ucyBjYWxjdWxhdGlvbnMgYXJlIGNvcnJlY3RcclxuICAgICAgICAgICAgdC5yZW1vdmVBdHRyKCdzdHlsZScpO1xyXG5cclxuICAgICAgICAgICAgdmFyIG9mZnNldCA9IGUub2Zmc2V0KCk7XHJcblxyXG4gICAgICAgICAgICB2YXIgd3cgPSAkKHdpbmRvdykud2lkdGgoKTtcclxuICAgICAgICAgICAgdmFyIHcgPSB0Lm91dGVyV2lkdGgoKTtcclxuICAgICAgICAgICAgdmFyIGxlZnQgPSBvZmZzZXQubGVmdCArIGUub3V0ZXJXaWR0aCgpIC8gMiAtIHcgLyAyO1xyXG5cclxuICAgICAgICAgICAgaWYgKGxlZnQgPCBtYXJnaW4pXHJcbiAgICAgICAgICAgICAgICBsZWZ0ID0gbWFyZ2luO1xyXG4gICAgICAgICAgICB2YXIgcmlnaHRPdmVyZmxvdyA9IChsZWZ0ICsgdykgLSAod3cgLSBtYXJnaW4pO1xyXG4gICAgICAgICAgICBpZihyaWdodE92ZXJmbG93ID4gMClcclxuICAgICAgICAgICAgICAgIGxlZnQgPSBNYXRoLm1heChsZWZ0IC0gcmlnaHRPdmVyZmxvdywgbWFyZ2luKTtcclxuXHJcbiAgICAgICAgICAgIHQuY3NzKHtcclxuICAgICAgICAgICAgICAgICdsZWZ0JzogbGVmdCArICdweCcsXHJcbiAgICAgICAgICAgICAgICAnbWF4LXdpZHRoJzogKHd3IC0gbGVmdCAtIG1hcmdpbikgKyAncHgnXHJcbiAgICAgICAgICAgIH0pLmZpbmQoJy50aXAnKVxyXG4gICAgICAgICAgICAgICAgLmNzcygnbGVmdCcsIG9mZnNldC5sZWZ0ICsgZS5vdXRlcldpZHRoKCkgLyAyIC0gbGVmdCArICdweCcpO1xyXG5cclxuICAgICAgICAgICAgLy9TZXR0aW5nIHdpZHRoIGNhbiBtYWtlIGhlaWdodCB2YXJ5LiBTbyB3ZSBzZXQgdmVydGljYWwgcG9zaXRpb24gYWZ0ZXIuXHJcbiAgICAgICAgICAgIHZhciBoID0gdC5vdXRlckhlaWdodCgpO1xyXG4gICAgICAgICAgICB0LmNzcygndG9wJywgby5wb3NpdGlvbiA9PSBQb3NpdGlvbi50b3BcclxuICAgICAgICAgICAgICAgID8gb2Zmc2V0LnRvcCAtIGggLSBvLmRpc3RhbmNlXHJcbiAgICAgICAgICAgICAgICA6IG9mZnNldC50b3AgKyBlLm91dGVySGVpZ2h0KCkgKyBvLmRpc3RhbmNlXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwdWJsaWMgY2xvc2UoKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdjbG9zZTIyJyk7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy50b29sdGlwKVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICBpZih0aGlzLm9wdGlvbnMuc291cmNlID09IFNvdXJjZS5hbmNob3IpXHJcbiAgICAgICAgICAgICAgICB0aGlzLmNvbnRlbnQuaGlkZSgpLmFwcGVuZFRvKCdib2R5Jyk7XHJcbiAgICAgICAgICAgIHRoaXMudG9vbHRpcC5yZW1vdmUoKTtcclxuICAgICAgICAgICAgdGhpcy50b29sdGlwID0gbnVsbDtcclxuICAgICAgICAgICAgdGhpcy50YXJnZXQuZGF0YSgndG9vbHRpcCcsIG51bGwpO1xyXG4gICAgICAgICAgICBhY3RpdmVUb29sdGlwcy5zcGxpY2UoYWN0aXZlVG9vbHRpcHMuaW5kZXhPZih0aGlzKSwgMSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59Il0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9